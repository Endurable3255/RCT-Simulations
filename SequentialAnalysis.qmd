---
title: "Sequential Analysis"
author: "Johannes Schwenke"
date: "2024-06-26"
format: 
  revealjs:
    logo: Logo_Unibas_USB_ALL.svg
editor: visual
---

```{r Setup}
#| label: load-packages
#| include: false
#| warning: false

library(rpact)
library(tidyverse)
library(glue)
library(ggplot2)
library(ggokabeito)


options(
  # set default colors in ggplot2 to colorblind-friendly
  # Okabe-Ito and Viridis palettes
  ggplot2.discrete.colour = ggokabeito::palette_okabe_ito(),
  ggplot2.discrete.fill = ggokabeito::palette_okabe_ito(),
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  # set theme font and size
  book.base_family = "sans",
  book.base_size = 14
)

# set default theme
theme_set(
  theme_minimal(
    base_size = getOption("book.base_size"),
    base_family = getOption("book.base_family")
  ) %+replace%
    theme(
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
)

## Load custom functions ----
source("functions/plot_interim_or_FstScs.R")
source("functions/plot_interim_or_OvScs.R")
source("functions/plot_interim_z.R")
source("functions/RCT_sim_mult_looks.R")
```

## One year ago... {.smaller}

![Unplanned interim analysis of effectiveness of meningococcal group B vaccine to prevent gonorrhoea.](images/DoxyVAC2.png){#DoxyVac_Interim}

## But then ... {.smaller}

. . .

"Full analysis of French STI study *dashes hopes* for a gonorrhoea vaccine".

![Effectiveness of meningococcal group B vaccine at final analysis.](images/DoxyVAC4.png){#DoxyVAC_final}

## Matthias was not amused {.smaller}

For had he himself not published on the subject more almost 17 (!) years ago?

![](images/Matthias_Paper.png)

> "Compelling evidence suggests that trials stopped early for benefit systematically overestimate treatment effects, sometimes by a large amount. Unresolved controversies in trials stopped early for benefit include ethical and statistical problems in the interpretation of results."

# What's all the fuss about interim analysis?

## Back to the basics: p-values

What was the definition of a p-value again?

. . .

> The definition of a p-value is the probability of observing the sample data, or more extreme data, assuming the null hypothesis is true.[^1]

[^1]: Lakens, [Improving Your Statistical Inferences](https://lakens.github.io/statistical_inferences/)

. . .

-   P-values are a statement about the **probability of data**, [not]{.underline} a statement about the probability of a hypothesis or the probability of a theory.

## Back to the basics: p-values

```{r fig-pdistr2, cache = TRUE, echo=FALSE}
#| fig-cap: "Distribution of *p*-values when the null hypothesis is true. ©Lakens"

#Set number of simulations
nSims <- 100000 #number of simulated experiments
p <-numeric(nSims) #set up empty variable to store all simulated *p*-values

for (i in 1:nSims) { # for each simulated experiment
  x <- rnorm(n = 71, mean = 100, sd = 15) # Simulate data
  y <- rnorm(n = 71, mean = 100, sd = 15) # Simulate data
  p[i] <- t.test(x, y)$p.value # store the *p*-value
}
  
bars<-20
#Plot figure
op <- par(mar = c(5,7,4,4)) #change white-space around graph
hist(p, breaks=bars, xlab="p-values", ylab="number of p-values\n", axes=FALSE,
     main=paste("p-value distribution when the null hypothesis is true"),
     col="grey", xlim=c(0,1), ylim=c(0, nSims))
axis(side=1, at=seq(0,1, 0.1), labels=seq(0,1,0.1))
axis(side=2, at=seq(0,nSims, nSims/4), labels=seq(0,nSims, nSims/4), las=2)
abline(h=nSims/bars, col = "red", lty=3, lwd = 2)

```

## Back to the basics: p-values

```{r fig-pdistr1, cache = TRUE, echo=FALSE}
#| fig-cap: "Distribution of *p*-values when power = 50%. ©Lakens" 

#Set number of simulations
nSims <- 100000 # number of simulated experiments
p <- numeric(nSims) # set up empty variable to store all simulated *p*-values
bars <- 20

for (i in 1:nSims) { # for each simulated experiment
  x <- rnorm(n = 71, mean = 100, sd = 15) # Simulate data
  y <- rnorm(n = 71, mean = 105, sd = 15) # Simulate data
  p[i] <- t.test(x, y)$p.value # store the *p*-value
}
  
#Plot figure
op <- par(mar = c(5,7,4,4)) #change white-space around graph
hist(p, breaks=bars, xlab="p-values", ylab="number of p-values\n", axes=FALSE,
     main=paste("p-value Distribution with 50% power"),
     col="grey", xlim=c(0,1), ylim=c(0, nSims))
axis(side=1, at=seq(0,1, 0.1), labels=seq(0,1,0.1))
axis(side=2, at=seq(0,nSims, nSims/4), labels=seq(0,nSims, nSims/4), las=2)
abline(h=nSims/bars, col = "red", lty=3, lwd = 2)

```

## Back to the basics: p-values

```{r fig-paradox, echo=FALSE}
#| fig-cap: "*P*-value distribution for 0 (grey horizontal line, 50 percent power (black solid curve), and 99 percent power (black dotted curve, where *p*-values just below 0.05 are more likely when $H_0$ is true than when $H_1$ is true). ©Lakens"
# Lindley plot

n <- 150
p <- 0.05
ymax <- 25 # Maximum value y-scale (only for p-curve)

# Calculations

# p-value function
pdf2_t <- function(p) 0.5 * dt(qt(p / 2, 2 * n - 2, 0), 2 * n - 2, ncp) / dt(qt(p / 2, 2 * n - 2, 0), 2 * n - 2, 0) + dt(qt(1 - p / 2, 2 * n - 2, 0), 2 * n - 2, ncp) / dt(qt(1 - p / 2, 2 * n - 2, 0), 2 * n - 2, 0)

plot(-10,
  xlab = "p-value", ylab = "Density", axes = FALSE,
  main = "p-value distribution for d = 0, 50% power, and 99% power", xlim = c(0, 1), ylim = c(0, ymax), cex.lab = 1.2, cex.main = 1.2, cex.sub = 1
)
axis(side = 1, at = seq(0, 1, 0.05), labels = formatC(seq(0, 1, 0.05), format = "f", digits = 2), cex.axis = 1)
# Draw null line
ncp <- (0 * sqrt(n / 2)) # Calculate non-centrality parameter d
curve(pdf2_t, 0, 1, n = 1000, col = "grey", lty = 1, lwd = 2, add = TRUE)
# Draw 50% low power line
n <- 146
d <- 0.23
se <- sqrt(2 / n) # standard error
ncp <- (d * sqrt(n / 2)) # Calculate non-centrality parameter d
curve(pdf2_t, 0, 1, n = 1000, col = "black", lwd = 3, add = TRUE)
# Draw 99% power line
n <- 150
d <- 0.5
se <- sqrt(2 / n) # standard error
ncp <- (d * sqrt(n / 2)) # Calculate non-centrality parameter d
curve(pdf2_t, 0, 1, n = 1000, col = "black", lwd = 3, lty = 3, add = TRUE)


```

## Back to the basics: Error control

```{r fig-errortypes, echo = FALSE, fig.cap='Difference between Type 1 and Type 2 errors. Figure made by <a href="https://effectsizefaq.com/2010/05/31/i-always-get-confused-about-type-i-and-ii-errors-can-you-show-me-something-to-help-me-remember-the-difference/">Paul Ellis</a>'}

knitr::include_graphics("images/type1type2error.jpg")

```

## Back to the basics: Error control {.smaller}

The desire to make scientific claims based on a methodological procedure that (when the assumptions are met), **limits the percentage of incorrect claims to a desired maximum value**.

. . .

$\rightarrow$ significance level $\alpha$!

. . .

```{r fig-pdistr3, cache = TRUE, echo=FALSE}
#| fig-height: 4.5
#| fig-width: 10

#Set number of simulations
nSims <- 100000 #number of simulated experiments
p <-numeric(nSims) #set up empty variable to store all simulated *p*-values

for (i in 1:nSims) { # for each simulated experiment
  x <- rnorm(n = 71, mean = 100, sd = 15) # Simulate data
  y <- rnorm(n = 71, mean = 100, sd = 15) # Simulate data
  p[i] <- t.test(x, y)$p.value # store the *p*-value
}
  
bars<-20
#Plot figure
op <- par(mar = c(5,7,4,4)) #change white-space around graph
hist(p, breaks=bars, xlab="p-values", ylab="number of p-values\n", axes=FALSE,
     main=paste("p-value distribution when the null hypothesis is true"),
     col="grey", xlim=c(0,1), ylim=c(0, nSims))
axis(side=1, at=seq(0,1, 0.1), labels=seq(0,1,0.1))
axis(side=2, at=seq(0,nSims, nSims/4), labels=seq(0,nSims, nSims/4), las=2)
abline(h=nSims/bars, col = "red", lty=3, lwd = 2)
abline(v=0.05, col = "blue", lty = 3, lwd = 2)

```

## Optional stopping leads to Type-I error inflation

![Simulated p-values for each additional observation when the null is true. ©Lakens](images/animatep.gif)

## 4 looks with stopping {.smaller .scrollable}

::: panel-tabset
### Plot

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 4.5

sim1 <- RCT_sim_mult_looks(seed = 2, death0 = 0.4, death1 = 0.3, nSims = 100, nPatients = 1e3, nLooks = 4, typeOfDesign = "OF")

sim2 <- RCT_sim_mult_looks(seed = 2, death0 = 0.4, death1 = 0.3, nSims = 100, nPatients = 1e3, nLooks = 4, typeOfDesign = "P")

#sim1$df_stopped_interim |> filter(first_success_index == 1) |> summarize(mean_OR = mean(or))
#sim1$df_not_stopped_interim |> filter((first_success_index == 1 | first_success_index == 2), (look == 2)) |> summarize(median_OR = median(or))
#sim1$df_not_stopped_interim |> filter(look == 3) |> summarize(median_OR = median(or))

sim1$trueOR

sim1$df_not_stopped_interim |> group_by(trial) |> slice_head(n = 1) |> ungroup() |> count(overall_success)

plot_interim_or_FstScs(data = sim1$df_stopped_interim, true_effect = sim1$trueOR, x_breaks = sim1$analyses_nPatients, design = sim1$design, event_rate = sim1$death0, title_suffix = "Stopped at interim")

plot_interim_or_FstScs(data = sim2$df_stopped_interim, true_effect = sim2$trueOR, x_breaks = sim2$analyses_nPatients, design = sim2$design, event_rate = sim2$death0, title_suffix = "Stopped at interim")

#plot_interim_or_OvScs(data = sim1$df_stopped_interim, true_effect = sim1$trueOR, x_breaks = sim1$analyses_nPatients, design = sim1$design, event_rate = sim1$death0, title_suffix = "Stopped at interim")


```

### Data

```{r}
knitr::kable(sim1$df_stopped_interim)
```
:::

## 4 looks without stopping {.smaller .scrollable}

::: panel-tabset
### Plot

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 4.5

plot_interim_or_FstScs(data = sim1$df_not_stopped_interim, true_effect = sim1$trueOR, x_breaks = sim1$analyses_nPatients, design = sim1$design, event_rate = sim1$death0, title_suffix = "Not stopped at interim")

plot_interim_or_OvScs(data = sim1$df_not_stopped_interim, true_effect = sim1$trueOR, x_breaks = sim1$analyses_nPatients, design = sim1$design, event_rate = sim1$death0, title_suffix = "Not stopped at interim")
```

### Data

```{r}
#knitr::kable(df_stopped_interim)
```
:::
